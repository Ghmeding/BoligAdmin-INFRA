"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RdsStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const aws_rds_1 = require("aws-cdk-lib/aws-rds");
class RdsStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const vpc = props.vpc;
        const engine = aws_rds_1.DatabaseInstanceEngine.postgres({ version: aws_rds_1.PostgresEngineVersion.VER_16 });
        const instanceType = aws_ec2_1.InstanceType.of(aws_ec2_1.InstanceClass.T3, aws_ec2_1.InstanceSize.MICRO);
        const port = 5432;
        const dbName = "BA_CORE_DB";
        const dbSg = new aws_ec2_1.SecurityGroup(this, 'RdsSecurityGroup', {
            securityGroupName: "BA_CORE_DB_SG",
            vpc: vpc
        });
        dbSg.addIngressRule(aws_ec2_1.Peer.ipv4(vpc.vpcCidrBlock), aws_ec2_1.Port.tcp(port), `Allow port ${port} for database connection from only within the VPC (${vpc.vpcId})`);
        // create RDS instance (PostgreSQL)
        const db = new aws_rds_1.DatabaseInstance(this, "ba_core_db", {
            vpc: vpc,
            vpcSubnets: { subnetType: aws_ec2_1.SubnetType.PRIVATE_ISOLATED },
            instanceType,
            engine,
            port,
            securityGroups: [dbSg],
            databaseName: dbName,
            credentials: aws_rds_1.Credentials.fromGeneratedSecret('ba_admin'),
            backupRetention: aws_cdk_lib_1.Duration.days(0),
            deleteAutomatedBackups: true,
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY
        });
        new aws_cdk_lib_1.CfnOutput(this, 'BA_CORE_DB_ENDPOINT', {
            value: db.dbInstanceEndpointAddress,
            description: 'Database endpoint (host)'
        });
        new aws_cdk_lib_1.CfnOutput(this, 'BA_CORE_DB_PORT', {
            value: db.dbInstanceEndpointPort,
            description: 'Database port'
        });
        new aws_cdk_lib_1.CfnOutput(this, 'BA_CORE_VPC', {
            value: vpc.vpcArn,
            description: 'VPC ARN'
        });
    }
}
exports.RdsStack = RdsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmRzLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmRzLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFpRztBQUNqRyxpREFBNEg7QUFDNUgsaURBQW1IO0FBT25ILE1BQWEsUUFBUyxTQUFRLG1CQUFLO0lBQy9CLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBb0I7UUFDMUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUN0QixNQUFNLE1BQU0sR0FBRyxnQ0FBc0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxPQUFPLEVBQUUsK0JBQXFCLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUMxRixNQUFNLFlBQVksR0FBRyxzQkFBWSxDQUFDLEVBQUUsQ0FBQyx1QkFBYSxDQUFDLEVBQUUsRUFBRSxzQkFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUM7UUFFNUIsTUFBTSxJQUFJLEdBQUcsSUFBSSx1QkFBYSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUNyRCxpQkFBaUIsRUFBRSxlQUFlO1lBQ2xDLEdBQUcsRUFBRSxHQUFHO1NBQ1gsQ0FBQyxDQUFDO1FBR0gsSUFBSSxDQUFDLGNBQWMsQ0FDZixjQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFDM0IsY0FBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFDZCxjQUFjLElBQUksc0RBQXNELEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FDdkYsQ0FBQztRQUVGLG1DQUFtQztRQUNuQyxNQUFNLEVBQUUsR0FBRyxJQUFJLDBCQUFnQixDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7WUFDaEQsR0FBRyxFQUFFLEdBQUc7WUFDUixVQUFVLEVBQUUsRUFBRSxVQUFVLEVBQUUsb0JBQVUsQ0FBQyxnQkFBZ0IsRUFBRTtZQUN2RCxZQUFZO1lBQ1osTUFBTTtZQUNOLElBQUk7WUFDSixjQUFjLEVBQUUsQ0FBQyxJQUFJLENBQUM7WUFDdEIsWUFBWSxFQUFFLE1BQU07WUFDcEIsV0FBVyxFQUFFLHFCQUFXLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDO1lBQ3hELGVBQWUsRUFBRSxzQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakMsc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixhQUFhLEVBQUUsMkJBQWEsQ0FBQyxPQUFPO1NBQ3ZDLENBQUMsQ0FBQztRQUVILElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUU7WUFDdkMsS0FBSyxFQUFFLEVBQUUsQ0FBQyx5QkFBeUI7WUFDbkMsV0FBVyxFQUFFLDBCQUEwQjtTQUMxQyxDQUFDLENBQUM7UUFFSCxJQUFJLHVCQUFTLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFO1lBQ25DLEtBQUssRUFBRSxFQUFFLENBQUMsc0JBQXNCO1lBQ2hDLFdBQVcsRUFBRSxlQUFlO1NBQy9CLENBQUMsQ0FBQztRQUVILElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQy9CLEtBQUssRUFBRSxHQUFHLENBQUMsTUFBTTtZQUNqQixXQUFXLEVBQUUsU0FBUztTQUN6QixDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFwREQsNEJBb0RDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2ZuT3V0cHV0LCBTdGFjaywgUmVtb3ZhbFBvbGljeSwgU3RhY2tQcm9wcywgU2VjcmV0VmFsdWUsIER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgVnBjLCBTZWN1cml0eUdyb3VwLCBQb3J0LCBQZWVyLCBTdWJuZXRUeXBlLCBJbnN0YW5jZVR5cGUsIEluc3RhbmNlQ2xhc3MsIEluc3RhbmNlU2l6ZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHsgRGF0YWJhc2VJbnN0YW5jZSwgRGF0YWJhc2VJbnN0YW5jZUVuZ2luZSwgQ3JlZGVudGlhbHMsIFBvc3RncmVzRW5naW5lVmVyc2lvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1yZHMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmRzU3RhY2tQcm9wcyBleHRlbmRzIFN0YWNrUHJvcHMge1xuICAgIHZwYzogVnBjO1xufVxuXG5leHBvcnQgY2xhc3MgUmRzU3RhY2sgZXh0ZW5kcyBTdGFjayB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFJkc1N0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAgICAgY29uc3QgdnBjID0gcHJvcHMudnBjO1xuICAgICAgICBjb25zdCBlbmdpbmUgPSBEYXRhYmFzZUluc3RhbmNlRW5naW5lLnBvc3RncmVzKHsgdmVyc2lvbjogUG9zdGdyZXNFbmdpbmVWZXJzaW9uLlZFUl8xNiB9KTtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlID0gSW5zdGFuY2VUeXBlLm9mKEluc3RhbmNlQ2xhc3MuVDMsIEluc3RhbmNlU2l6ZS5NSUNSTyk7XG4gICAgICAgIGNvbnN0IHBvcnQgPSA1NDMyO1xuICAgICAgICBjb25zdCBkYk5hbWUgPSBcIkJBX0NPUkVfREJcIjtcblxuICAgICAgICBjb25zdCBkYlNnID0gbmV3IFNlY3VyaXR5R3JvdXAodGhpcywgJ1Jkc1NlY3VyaXR5R3JvdXAnLCB7XG4gICAgICAgICAgICBzZWN1cml0eUdyb3VwTmFtZTogXCJCQV9DT1JFX0RCX1NHXCIsXG4gICAgICAgICAgICB2cGM6IHZwY1xuICAgICAgICB9KTtcblxuXG4gICAgICAgIGRiU2cuYWRkSW5ncmVzc1J1bGUoXG4gICAgICAgICAgICBQZWVyLmlwdjQodnBjLnZwY0NpZHJCbG9jayksXG4gICAgICAgICAgICBQb3J0LnRjcChwb3J0KSxcbiAgICAgICAgICAgIGBBbGxvdyBwb3J0ICR7cG9ydH0gZm9yIGRhdGFiYXNlIGNvbm5lY3Rpb24gZnJvbSBvbmx5IHdpdGhpbiB0aGUgVlBDICgke3ZwYy52cGNJZH0pYFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIGNyZWF0ZSBSRFMgaW5zdGFuY2UgKFBvc3RncmVTUUwpXG4gICAgICAgIGNvbnN0IGRiID0gbmV3IERhdGFiYXNlSW5zdGFuY2UodGhpcywgXCJiYV9jb3JlX2RiXCIsIHtcbiAgICAgICAgICAgIHZwYzogdnBjLFxuICAgICAgICAgICAgdnBjU3VibmV0czogeyBzdWJuZXRUeXBlOiBTdWJuZXRUeXBlLlBSSVZBVEVfSVNPTEFURUQgfSxcbiAgICAgICAgICAgIGluc3RhbmNlVHlwZSxcbiAgICAgICAgICAgIGVuZ2luZSxcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBzZWN1cml0eUdyb3VwczogW2RiU2ddLFxuICAgICAgICAgICAgZGF0YWJhc2VOYW1lOiBkYk5hbWUsXG4gICAgICAgICAgICBjcmVkZW50aWFsczogQ3JlZGVudGlhbHMuZnJvbUdlbmVyYXRlZFNlY3JldCgnYmFfYWRtaW4nKSxcbiAgICAgICAgICAgIGJhY2t1cFJldGVudGlvbjogRHVyYXRpb24uZGF5cygwKSxcbiAgICAgICAgICAgIGRlbGV0ZUF1dG9tYXRlZEJhY2t1cHM6IHRydWUsXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1lcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV3IENmbk91dHB1dCh0aGlzLCAnQkFfQ09SRV9EQl9FTkRQT0lOVCcsIHtcbiAgICAgICAgICAgIHZhbHVlOiBkYi5kYkluc3RhbmNlRW5kcG9pbnRBZGRyZXNzLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdEYXRhYmFzZSBlbmRwb2ludCAoaG9zdCknXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ0JBX0NPUkVfREJfUE9SVCcsIHtcbiAgICAgICAgICAgIHZhbHVlOiBkYi5kYkluc3RhbmNlRW5kcG9pbnRQb3J0LFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdEYXRhYmFzZSBwb3J0J1xuICAgICAgICB9KTtcblxuICAgICAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdCQV9DT1JFX1ZQQycsIHtcbiAgICAgICAgICAgIHZhbHVlOiB2cGMudnBjQXJuLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdWUEMgQVJOJ1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=