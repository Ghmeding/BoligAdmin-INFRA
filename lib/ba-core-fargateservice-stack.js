"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaCoreFargateServicestack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const aws_ecs_1 = require("aws-cdk-lib/aws-ecs");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
class BaCoreFargateServicestack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const dbEndpoint = aws_cdk_lib_1.Fn.importValue("BA_CORE_DB_ENDPOINT");
        const cluster = props.cluster;
        const vpc = props.vpc;
        // TASK IAM ROLE
        const executionRole = new aws_iam_1.Role(this, "FargateExecutionRole", {
            assumedBy: new aws_iam_1.ServicePrincipal("ecs-tasks.amazonaws.com"),
            managedPolicies: [
                aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonECSTaskExecutionRolePolicy")
            ]
        });
        // TASK DEFINITION
        const taskDef = new aws_ecs_1.FargateTaskDefinition(this, 'TaskDef', {
            executionRole: executionRole,
            memoryLimitMiB: 512,
            cpu: 256
        });
        // Create security group for Fargate tasks
        const fargateServiceSg = new aws_ec2_1.SecurityGroup(this, 'FargateServiceSG', {
            vpc: vpc,
            description: 'Security group for Fargate Service',
            allowAllOutbound: true
        });
        // Allow inbound port 8080 from ALB security group
        fargateServiceSg.addIngressRule(aws_ec2_1.Peer.securityGroupId(props.albSecurityGroup.securityGroupId), aws_ec2_1.Port.tcp(8080), 'Allow ALB health check and traffic');
        // Allow inbound from VPC for internal service-to-service calls
        fargateServiceSg.addIngressRule(aws_ec2_1.Peer.ipv4(props.vpc.vpcCidrBlock), aws_ec2_1.Port.tcp(8080), 'Allow internal VPC traffic for service-to-service calls');
        const container = taskDef.addContainer('AppContainer', {
            image: aws_ecs_1.ContainerImage.fromEcrRepository(props.ecrRepository),
            memoryLimitMiB: 512,
            cpu: 256,
            //TODO: insert secrets dynamically
            environment: {
                SPRING_DATASOURCE_URL: dbEndpoint,
                SPRING_DATASOURCE_USERNAME: process.env.SPRING_DATASOURCE_USERNAME || "",
                SPRING_DATASOURCE_PASSWORD: process.env.SPRING_DATASOURCE_PASSWORD || "",
            },
            healthCheck: {
                command: [
                    "CMD-SHELL",
                    "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
                ],
                interval: aws_cdk_lib_1.Duration.seconds(30),
                timeout: aws_cdk_lib_1.Duration.seconds(10),
                retries: 3,
                startPeriod: aws_cdk_lib_1.Duration.seconds(90)
            }
        });
    }
}
exports.BaCoreFargateServicestack = BaCoreFargateServicestack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmEtY29yZS1mYXJnYXRlc2VydmljZS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJhLWNvcmUtZmFyZ2F0ZXNlcnZpY2Utc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQThEO0FBQzlELGlEQUFxRjtBQUVyRixpREFBc0Y7QUFFdEYsaURBQTRFO0FBWTVFLE1BQWEseUJBQTBCLFNBQVEsbUJBQUs7SUFDaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQztRQUN0RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUc1QixNQUFNLFVBQVUsR0FBRyxnQkFBRSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXpELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDOUIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUV0QixnQkFBZ0I7UUFDaEIsTUFBTSxhQUFhLEdBQUcsSUFBSSxjQUFJLENBQUMsSUFBSSxFQUFFLHNCQUFzQixFQUFFO1lBQ3pELFNBQVMsRUFBRSxJQUFJLDBCQUFnQixDQUFDLHlCQUF5QixDQUFDO1lBQzFELGVBQWUsRUFBRTtnQkFDYix1QkFBYSxDQUFDLHdCQUF3QixDQUNsQywrQ0FBK0MsQ0FDbEQ7YUFDSjtTQUNKLENBQUMsQ0FBQztRQUVILGtCQUFrQjtRQUNsQixNQUFNLE9BQU8sR0FBRyxJQUFJLCtCQUFxQixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUU7WUFDdkQsYUFBYSxFQUFFLGFBQWE7WUFDNUIsY0FBYyxFQUFFLEdBQUc7WUFDbkIsR0FBRyxFQUFFLEdBQUc7U0FDWCxDQUFDLENBQUM7UUFFSCwwQ0FBMEM7UUFDMUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHVCQUFhLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQ2pFLEdBQUcsRUFBRSxHQUFHO1lBQ1IsV0FBVyxFQUFFLG9DQUFvQztZQUNqRCxnQkFBZ0IsRUFBRSxJQUFJO1NBQ3pCLENBQUMsQ0FBQztRQUVILGtEQUFrRDtRQUNsRCxnQkFBZ0IsQ0FBQyxjQUFjLENBQzNCLGNBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxFQUM1RCxjQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUNkLG9DQUFvQyxDQUN2QyxDQUFDO1FBRUYsK0RBQStEO1FBQy9ELGdCQUFnQixDQUFDLGNBQWMsQ0FDM0IsY0FBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUNqQyxjQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUNkLHlEQUF5RCxDQUM1RCxDQUFDO1FBRUYsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxjQUFjLEVBQUU7WUFDbkQsS0FBSyxFQUFFLHdCQUFjLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQztZQUM1RCxjQUFjLEVBQUUsR0FBRztZQUNuQixHQUFHLEVBQUUsR0FBRztZQUNSLGtDQUFrQztZQUNsQyxXQUFXLEVBQUU7Z0JBQ1QscUJBQXFCLEVBQUUsVUFBVTtnQkFDakMsMEJBQTBCLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsSUFBSSxFQUFFO2dCQUN4RSwwQkFBMEIsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixJQUFJLEVBQUU7YUFDM0U7WUFDRCxXQUFXLEVBQUU7Z0JBQ1QsT0FBTyxFQUFFO29CQUNMLFdBQVc7b0JBQ1gsNkVBQTZFO2lCQUNoRjtnQkFDRCxRQUFRLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUM5QixPQUFPLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUM3QixPQUFPLEVBQUUsQ0FBQztnQkFDVixXQUFXLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2FBQ3BDO1NBQ0osQ0FBQyxDQUFDO0lBR0gsQ0FBQztDQUNKO0FBeEVELDhEQXdFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER1cmF0aW9uLCBGbiwgU3RhY2ssIFN0YWNrUHJvcHMgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IElTZWN1cml0eUdyb3VwLCBQZWVyLCBQb3J0LCBTZWN1cml0eUdyb3VwLCBWcGMgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0IHsgSVJlcG9zaXRvcnkgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjclwiO1xuaW1wb3J0IHsgQ29udGFpbmVySW1hZ2UsIEZhcmdhdGVUYXNrRGVmaW5pdGlvbiwgSUNsdXN0ZXIgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjc1wiO1xuaW1wb3J0IHsgSUFwcGxpY2F0aW9uTG9hZEJhbGFuY2VyLCBJQXBwbGljYXRpb25UYXJnZXRHcm91cCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWxhc3RpY2xvYWRiYWxhbmNpbmd2MlwiO1xuaW1wb3J0IHsgTWFuYWdlZFBvbGljeSwgUm9sZSwgU2VydmljZVByaW5jaXBhbCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJhQ29yZUZhcmdhdGVTZXJ2aWNlU3RhY2sgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgICB2cGM6IFZwYztcbiAgICBlY3JSZXBvc2l0b3J5OiBJUmVwb3NpdG9yeTtcbiAgICBsb2FkQmFsYW5jZXI6IElBcHBsaWNhdGlvbkxvYWRCYWxhbmNlcjtcbiAgICB0YXJnZXRHcm91cDogSUFwcGxpY2F0aW9uVGFyZ2V0R3JvdXA7XG4gICAgY2x1c3RlcjogSUNsdXN0ZXI7XG4gICAgYWxiU2VjdXJpdHlHcm91cDogSVNlY3VyaXR5R3JvdXA7XG59XG5cbmV4cG9ydCBjbGFzcyBCYUNvcmVGYXJnYXRlU2VydmljZXN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBCYUNvcmVGYXJnYXRlU2VydmljZVN0YWNrKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuICAgIFxuXG4gICAgY29uc3QgZGJFbmRwb2ludCA9IEZuLmltcG9ydFZhbHVlKFwiQkFfQ09SRV9EQl9FTkRQT0lOVFwiKTtcblxuICAgIGNvbnN0IGNsdXN0ZXIgPSBwcm9wcy5jbHVzdGVyO1xuICAgIGNvbnN0IHZwYyA9IHByb3BzLnZwYztcblxuICAgIC8vIFRBU0sgSUFNIFJPTEVcbiAgICBjb25zdCBleGVjdXRpb25Sb2xlID0gbmV3IFJvbGUodGhpcywgXCJGYXJnYXRlRXhlY3V0aW9uUm9sZVwiLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IFNlcnZpY2VQcmluY2lwYWwoXCJlY3MtdGFza3MuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgICAgbWFuYWdlZFBvbGljaWVzOiBbXG4gICAgICAgICAgICBNYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcbiAgICAgICAgICAgICAgICBcInNlcnZpY2Utcm9sZS9BbWF6b25FQ1NUYXNrRXhlY3V0aW9uUm9sZVBvbGljeVwiXG4gICAgICAgICAgICApXG4gICAgICAgIF1cbiAgICB9KTtcblxuICAgIC8vIFRBU0sgREVGSU5JVElPTlxuICAgIGNvbnN0IHRhc2tEZWYgPSBuZXcgRmFyZ2F0ZVRhc2tEZWZpbml0aW9uKHRoaXMsICdUYXNrRGVmJywge1xuICAgICAgICBleGVjdXRpb25Sb2xlOiBleGVjdXRpb25Sb2xlLFxuICAgICAgICBtZW1vcnlMaW1pdE1pQjogNTEyLFxuICAgICAgICBjcHU6IDI1NlxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIHNlY3VyaXR5IGdyb3VwIGZvciBGYXJnYXRlIHRhc2tzXG4gICAgY29uc3QgZmFyZ2F0ZVNlcnZpY2VTZyA9IG5ldyBTZWN1cml0eUdyb3VwKHRoaXMsICdGYXJnYXRlU2VydmljZVNHJywge1xuICAgICAgICB2cGM6IHZwYyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZWN1cml0eSBncm91cCBmb3IgRmFyZ2F0ZSBTZXJ2aWNlJyxcbiAgICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZVxuICAgIH0pO1xuXG4gICAgLy8gQWxsb3cgaW5ib3VuZCBwb3J0IDgwODAgZnJvbSBBTEIgc2VjdXJpdHkgZ3JvdXBcbiAgICBmYXJnYXRlU2VydmljZVNnLmFkZEluZ3Jlc3NSdWxlKFxuICAgICAgICBQZWVyLnNlY3VyaXR5R3JvdXBJZChwcm9wcy5hbGJTZWN1cml0eUdyb3VwLnNlY3VyaXR5R3JvdXBJZCksXG4gICAgICAgIFBvcnQudGNwKDgwODApLFxuICAgICAgICAnQWxsb3cgQUxCIGhlYWx0aCBjaGVjayBhbmQgdHJhZmZpYydcbiAgICApO1xuXG4gICAgLy8gQWxsb3cgaW5ib3VuZCBmcm9tIFZQQyBmb3IgaW50ZXJuYWwgc2VydmljZS10by1zZXJ2aWNlIGNhbGxzXG4gICAgZmFyZ2F0ZVNlcnZpY2VTZy5hZGRJbmdyZXNzUnVsZShcbiAgICAgICAgUGVlci5pcHY0KHByb3BzLnZwYy52cGNDaWRyQmxvY2spLFxuICAgICAgICBQb3J0LnRjcCg4MDgwKSxcbiAgICAgICAgJ0FsbG93IGludGVybmFsIFZQQyB0cmFmZmljIGZvciBzZXJ2aWNlLXRvLXNlcnZpY2UgY2FsbHMnXG4gICAgKTtcblxuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRhc2tEZWYuYWRkQ29udGFpbmVyKCdBcHBDb250YWluZXInLCB7XG4gICAgICAgIGltYWdlOiBDb250YWluZXJJbWFnZS5mcm9tRWNyUmVwb3NpdG9yeShwcm9wcy5lY3JSZXBvc2l0b3J5KSxcbiAgICAgICAgbWVtb3J5TGltaXRNaUI6IDUxMixcbiAgICAgICAgY3B1OiAyNTYsXG4gICAgICAgIC8vVE9ETzogaW5zZXJ0IHNlY3JldHMgZHluYW1pY2FsbHlcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgIFNQUklOR19EQVRBU09VUkNFX1VSTDogZGJFbmRwb2ludCxcbiAgICAgICAgICAgIFNQUklOR19EQVRBU09VUkNFX1VTRVJOQU1FOiBwcm9jZXNzLmVudi5TUFJJTkdfREFUQVNPVVJDRV9VU0VSTkFNRSB8fCBcIlwiLFxuICAgICAgICAgICAgU1BSSU5HX0RBVEFTT1VSQ0VfUEFTU1dPUkQ6IHByb2Nlc3MuZW52LlNQUklOR19EQVRBU09VUkNFX1BBU1NXT1JEIHx8IFwiXCIsXG4gICAgICAgIH0sXG4gICAgICAgIGhlYWx0aENoZWNrOiB7XG4gICAgICAgICAgICBjb21tYW5kOiBbXG4gICAgICAgICAgICAgICAgXCJDTUQtU0hFTExcIixcbiAgICAgICAgICAgICAgICBcIndnZXQgLS1uby12ZXJib3NlIC0tdHJpZXM9MSAtLXNwaWRlciBodHRwOi8vbG9jYWxob3N0OjgwODAvaGVhbHRoIHx8IGV4aXQgMVwiXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgaW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgICAgICAgICAgdGltZW91dDogRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgICAgICAgICByZXRyaWVzOiAzLFxuICAgICAgICAgICAgc3RhcnRQZXJpb2Q6IER1cmF0aW9uLnNlY29uZHMoOTApXG4gICAgICAgIH1cbiAgICB9KTtcblxuXG4gICAgfVxufSJdfQ==